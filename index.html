
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<!-- <link rel="stylesheet" type="text/css" href="./build/potree/potree.css"> -->
	<link rel="stylesheet" type="text/css" href="./libs/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="./libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="./libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="./libs/jstree/themes/mixed/style.css">
	<link rel="stylesheet" type="text/css" href="./libs/Cesium/Widgets/CesiumWidget/CesiumWidget.css">
</head>

<body>
	<script src="./libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="./libs/spectrum/spectrum.js"></script>
	<script src="./libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="./libs/three.js/build/three.min.js"></script>
	<script src="./libs/three.js/extra/lines.js"></script>
	<script src="./libs/other/BinaryHeap.js"></script>
	<script src="./libs/tween/tween.min.js"></script>
	<script src="./libs/d3/d3.js"></script>
	<script src="./libs/proj4/proj4.js"></script>
	<script src="./libs/openlayers3/ol.js"></script>
	<script src="./libs/i18next/i18next.js"></script>
	<script src="./libs/jstree/jstree.js"></script>
	<!-- <script src="./build/potree/potree.js"></script> -->
	<script src="./libs/potree/potree.js"></script>
	<script src="./libs/plasio/js/laslaz.js"></script>
	<script src="./libs/Cesium/Cesium.js"></script>
	<script src="./libs/other/OBJLoader.js"></script>
	<script src="./libs/other/PLYLoader.js"></script>
	<script src="./libs/other/MTLLoader.js"></script>
	
<!-- import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r110/build/three.module.js'; -->
<!-- import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r110/examples/jsm/controls/OrbitControls.js'; -->
<!-- import {OBJLoader2} from 'https://threejsfundamentals.org/threejs/resources/threejs/r110/examples/jsm/loaders/OBJLoader2.js'; -->
<!-- import {MTLLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r110/examples/jsm/loaders/MTLLoader.js'; -->
<!-- import {MtlObjBridge} from 'https://threejsfundamentals.org/threejs/resources/threejs/r110/examples/jsm/loaders/obj2/bridge/MtlObjBridge.js'; -->
	
	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
	<!-- INCLUDE SETTINGS HERE -->
	
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		
		<div id="potree_render_area" style="background-image: url('./libs/potree/resources/images/background.jpg');">
			<div id="cesiumContainer" style="position: absolute; width: 100%; height: 100%; background-color:green"></div>
		</div>
		<div id="potree_sidebar_container"> </div>
	</div>


<script>


	window.cesiumViewer = new Cesium.Viewer('cesiumContainer', {
		useDefaultRenderLoop: false,
		animation: false,
		baseLayerPicker : false,
		fullscreenButton: false, 
		geocoder: false,
		homeButton: false,
		infoBox: false,
		sceneModePicker: false,
		selectionIndicator: false,
		timeline: false,
		navigationHelpButton: false,
		imageryProvider : new Cesium.ArcGisMapServerImageryProvider({url : 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'}),
		terrainShadows: Cesium.ShadowMode.DISABLED,
	});

	//let cp = new Cesium.Cartesian3(4303414.154026048, 552161.235598733, 4660771.704035539);
	let cp = new Cesium.Cartesian3(3653195.24316105, 1399365.12970315, 5020791.13332193);
	cesiumViewer.camera.setView({
		destination : cp,
		orientation: {
			heading : 10, 
			pitch : -Cesium.Math.PI_OVER_TWO * 0.5, 
			roll : 0.0 
		}
	});

	window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"), {
		useDefaultRenderLoop: false
	});
	viewer.setEDLEnabled(true);
	viewer.setFOV(60);
	viewer.setPointBudget(1000*1000);
	viewer.setMinNodeSize(0);
	viewer.loadSettingsFromURL();
	viewer.setBackground(null);
	//potreeViewer.setBackground("gradient"); // ["skybox", "gradient", "black", "white"];
	viewer.setDescription(`Test renderowania chmury punktów - Żoliborz<br><a href="http://pryzmap.pl" target="_blank">PRYZMAP</a><br>Oskar Graszka`);

	viewer.loadGUI(() => {
	viewer.setLanguage('en');
	$("#menu_appearance").next().show();
	//$("#menu_appearance").next().show();
	//$("#menu_tools").next().show();
	//$("#menu_clipping").next().show();
	//viewer.toggleSidebar();
	});
	
	Potree.loadPointCloud("pointclouds/test/cloud.js", "test", e => {
		viewer.scene.addPointCloud(e.pointcloud);
		e.pointcloud.position.z = -10;
		let material = e.pointcloud.material;
		material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
		
		viewer.scene.view.position.set(633925.194,	490256.401,	11.884);
		viewer.scene.view.lookAt(new THREE.Vector3(633923.178,	490289.829,	5.726));
		
		viewer.scene.annotations.add(new Potree.Annotation({
				position: [633923.101, 490290.305, 5.8],
				cameraPosition: [633929.708,	490284.576,	6.623],
				cameraTarget: [633924.675,	490289.841,	4.600],
				title: "PLY",
				//description: `<p style="text-align:center;"><b>VW T2`
			}));
		viewer.scene.annotations.add(new Potree.Annotation({
				position: [633922.101, 490280.305, 5.8],
				cameraPosition: [633929.708,	490275.305,	6.623],
				cameraTarget: [633922.101, 490280.305,	4.600],
				title: "PLY + material",
			}));
		viewer.scene.annotations.add(new Potree.Annotation({
				position: [633920.101, 490270.305, 5.8],
				cameraPosition: [633929.708, 490265.305,	6.623],
				cameraTarget: [633920.101, 490270.305,	4.600],
				title: "OBJ",
			}));

		Potree.measureTimings = true;
		

		let pointcloudProjection = e.pointcloud.projection;
		let mapProjection = proj4.defs("WGS84");

		window.toMap = proj4(pointcloudProjection, mapProjection);
		window.toScene = proj4(mapProjection, pointcloudProjection);
		
		{
			let bb = viewer.getBoundingBox();

			let minWGS84 = proj4(pointcloudProjection, mapProjection, bb.min.toArray());
			let maxWGS84 = proj4(pointcloudProjection, mapProjection, bb.max.toArray());
		}
	});
		{ // LIGHTS
			const directional = new THREE.DirectionalLight( 0xffffff, 1.0);
			directional.position.set( 10, 10, 10 );
			directional.lookAt(0, 0, 0);

			const ambient = new THREE.AmbientLight(0x555555);

			viewer.scene.scene.add(directional);
			viewer.scene.scene.add(ambient);
		}
/*
		{ // Load Textured bunny from obj
			let manager = new THREE.LoadingManager();
			manager.onProgress = function ( item, loaded, total ) {
				console.log( item, loaded, total );
			};
			let textureLoader = new THREE.TextureLoader( manager );
			let texture = textureLoader.load(`models/bus_obj/Bus_0.jpg`);
			let onProgress = function ( xhr ) {
				if ( xhr.lengthComputable ) {
					let percentComplete = xhr.loaded / xhr.total * 100;
					console.log( Math.round(percentComplete, 2) + '% downloaded' );
				}
			};
			texture.wrapS = THREE.RepeatWrapping;
			texture.wrapT = THREE.RepeatWrapping;

			let onError = function ( xhr ) {};
			let loader = new THREE.OBJLoader( manager );
			loader.load(`models/test.obj`, function ( object ) {
				object.traverse( function ( child ) {
					if ( child instanceof THREE.Mesh ) {
						child.material.map = texture;
					}
				} );

				object.position.set(633920.101, 490270.305, 3.8);
				object.scale.multiplyScalar(1);
				object.rotation.set(Math.PI / 2, Math.PI, 0)

				viewer.scene.scene.add( object );

				viewer.onGUILoaded(() => {
					// Add entries to object list in sidebar
					let tree = $(`#jstree_scene`);
					let parentNode = "other";

					let bunnyID = tree.jstree('create_node', parentNode, { 
							text: "T2 - OBJ", 
							icon: `${Potree.resourcePath}/icons/triangle.svg`,
							data: object
						}, 
						"last", false, false);
					tree.jstree(object.visible ? "check_node" : "uncheck_node", bunnyID);

					//tree.jstree("open_node", parentNode);
				});

			}, onProgress, onError );
		}
		*/
	// Load from ply
	var loader = new THREE.PLYLoader();
		loader.load( "models/test.ply", (geometry) => {
			geometry.computeVertexNormals();
			
			// place two instances of this bunny into the scene
			
			let mesh1;
			{
				let material = new THREE.MeshNormalMaterial({
                    color: 0xaa4c18,
					metalness: 0.5,
					roughness: 0.8,
					//clearCoat:  0.15,
					//clearCoatRoughness: 0.37,
					reflectivity: 0.32});
                
                //let material = new THREE.MeshBasicMaterial( {color: 0x00ff00} );
                //let material = new THREE.MeshBasicMaterial( {color: 534636} );
                /*let material = new THREE.MeshPhysicalMaterial( {
					color: 0xaa4c18,
					metalness: 0.5,
					roughness: 0.8,
					//clearCoat:  0.15,
					//clearCoatRoughness: 0.37,
					reflectivity: 0.32
				} );*/
				
				mesh1 = new THREE.Mesh( geometry, material);
				mesh1.position.set(633923.101, 490290.305, 3.8);
				mesh1.scale.multiplyScalar(1);
				mesh1.rotation.set(Math.PI / 2, Math.PI, 0)
				viewer.scene.scene.add(mesh1);
			}
			
			/*let mesh2;
			{
				let material = new THREE.MeshPhysicalMaterial( {
					color: 0xaa4c18,
					metalness: 0.5,
					roughness: 0.8,
					//clearCoat:  0.15,
					//clearCoatRoughness: 0.37,
					reflectivity: 0.32
				} );
				mesh2 = new THREE.Mesh( geometry, material );
				mesh2.position.set(633922.101, 490280.305, 3.8);
				mesh2.scale.multiplyScalar(1);
				mesh2.rotation.set(Math.PI / 2, Math.PI, 0)
				viewer.scene.scene.add(mesh2);
			}*/
            /*
			viewer.onGUILoaded(() => {
				// Add entries to object list in sidebar
				let tree = $(`#jstree_scene`);
				let parentNode = "other";

				let bunny1ID = tree.jstree('create_node', parentNode, { 
						text: "T2 - PLY ", 
						icon: `${Potree.resourcePath}/icons/triangle.svg`,
						data: mesh1
					}, 
					"last", false, false);
				tree.jstree(mesh1.visible ? "check_node" : "uncheck_node", bunny1ID);

				let bunny2ID = tree.jstree('create_node', parentNode, { 
						text: "T2 - PLY2", 
						icon: `${Potree.resourcePath}/icons/triangle.svg`,
						data: mesh2
					}, 
					"last", false, false);
				tree.jstree(mesh2.visible ? "check_node" : "uncheck_node", bunny2ID);
			});*/
			
	});
	
	function loop(timestamp){
		requestAnimationFrame(loop);

		viewer.update(viewer.clock.getDelta(), timestamp);

		viewer.render();

		if(window.toMap !== undefined){

			{
				let camera = viewer.scene.getActiveCamera();

				let pPos		= new THREE.Vector3(0, 0, 0).applyMatrix4(camera.matrixWorld);
				let pRight  = new THREE.Vector3(600, 0, 0).applyMatrix4(camera.matrixWorld);
				let pUp		 = new THREE.Vector3(0, 600, 0).applyMatrix4(camera.matrixWorld);
				let pTarget = viewer.scene.view.getPivot();

				let toCes = (pos) => {
					let xy = [pos.x, pos.y];
					let height = pos.z;
					let deg = toMap.forward(xy);
					let cPos = Cesium.Cartesian3.fromDegrees(...deg, height);

					return cPos;
				};

				let cPos = toCes(pPos);
				let cUpTarget = toCes(pUp);
				let cTarget = toCes(pTarget);

				let cDir = Cesium.Cartesian3.subtract(cTarget, cPos, new Cesium.Cartesian3());
				let cUp = Cesium.Cartesian3.subtract(cUpTarget, cPos, new Cesium.Cartesian3());

				cDir = Cesium.Cartesian3.normalize(cDir, new Cesium.Cartesian3());
				cUp = Cesium.Cartesian3.normalize(cUp, new Cesium.Cartesian3());

				cesiumViewer.camera.setView({
					destination : cPos,
					orientation : {
						direction : cDir,
						up : cUp
					}
				});
				
			}

			let aspect = viewer.scene.getActiveCamera().aspect;
			if(aspect < 1){
				let fovy = Math.PI * (viewer.scene.getActiveCamera().fov / 180);
				cesiumViewer.camera.frustum.fov = fovy;
			}else{
				let fovy = Math.PI * (viewer.scene.getActiveCamera().fov / 180);
				let fovx = Math.atan(Math.tan(0.5 * fovy) * aspect) * 2
				cesiumViewer.camera.frustum.fov = fovx;
			}
			
		}

		cesiumViewer.render();
	}

	requestAnimationFrame(loop);


  </script>
</body>
</html>
